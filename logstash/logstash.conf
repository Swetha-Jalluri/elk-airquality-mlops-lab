# Logstash Configuration for Air Quality ML Pipeline
# Simplified version for reliable operation

input {
  # Training logs from file
  file {
    path => "/logstash_dir/training.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    type => "training"
  }
  
  # Prediction logs from API
  file {
    path => "/logstash_dir/predictions.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    type => "predictions"
  }
  
  # Drift detection logs
  file {
    path => "/logstash_dir/drift_detection.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    type => "drift"
  }
  
  # Kafka stream for real-time predictions
  kafka {
    bootstrap_servers => "kafka:29092"
    topics => ["air-quality-predictions"]
    codec => json
    type => "kafka_predictions"
    group_id => "logstash_consumer"
  }
  
  # Kafka stream for drift alerts
  kafka {
    bootstrap_servers => "kafka:29092"
    topics => ["drift-alerts"]
    codec => json
    type => "kafka_drift"
    group_id => "logstash_consumer"
  }
}

filter {
  # Add timestamp if not present
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }
  
  # Parse timestamp
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
    }
  }
  
  # Add metadata
  mutate {
    add_field => {
      "environment" => "development"
      "service" => "air-quality-ml"
    }
  }
  
  # Process training logs
  if [type] == "training" {
    mutate {
      convert => {
        "accuracy" => "float"
        "f1_score" => "float"
        "training_time_seconds" => "float"
      }
      add_tag => ["ml_training"]
    }
  }
  
  # Process prediction logs
  if [type] == "predictions" or [type] == "kafka_predictions" {
    mutate {
      convert => {
        "confidence" => "float"
      }
      add_tag => ["ml_prediction"]
    }
  }
  
  # Process drift logs
  if [type] == "drift" or [type] == "kafka_drift" {
    mutate {
      convert => {
        "drift_score" => "float"
      }
      add_tag => ["drift_detection"]
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "airquality-%{type}-%{+YYYY.MM.dd}"
  }
  
  # Debug output
  stdout {
    codec => rubydebug
  }
}